version: 2.1

jobs: 
  dead-link-test:
    machine:
      image: ubuntu-1604:201903-01
    steps:
      - checkout
      - run:
          name: Install & Set up go
          command: |
            sudo apt-get update -qq
            sudo apt-get install git
            sudo apt-get install -y python-dev python3-dev -qq
            if  [ -f goinstall.sh ]; then
                rm goinstall.sh
            fi
            if [ -d ~/.go ]; then
              rm -rf ~/.go
            fi
            wget https://raw.githubusercontent.com/canha/golang-tools-install-script/master/goinstall.sh
            sudo chown circleci goinstall.sh
            sudo chmod +x goinstall.sh
            ./goinstall.sh
      - run:
          name: Install Liche
          command: |
            echo 'export GOROOT=~/.go' >> $BASH_ENV
            echo 'export PATH=$GOROOT/bin:$PATH' >> $BASH_ENV
            echo 'export GOPATH=~/go' >> $BASH_ENV
            echo 'export PATH=$GOPATH/bin:$PATH' >> $BASH_ENV
            echo 'export GO111MODULE="on"' >> $BASH_ENV
            source $BASH_ENV
            go get -u github.com/raviqqe/liche
      - run:
          name: Check for broken links with Liche
          command: |
            liche README.md -v
            liche DesignRationales.md -v
            liche System_Requirements.md -v
            liche -r 1_Ventilator_System_Design -d . -v
            # TODO:
            # liche -r 2_Research_&_Development -d . -v
            # liche -r 3_Quality_Assurance -d . -v
            # liche -r 4_Prototype_Assembly -d . -v
            # -r: search for links through directories recursively
            # -d: set document root directory
            # -v: verbose output
            # -t: HTTP time-out limit (seconds)
workflows:
  commit:
    jobs:
      - dead-link-test
