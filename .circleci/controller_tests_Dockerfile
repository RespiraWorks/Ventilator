# This Dockerfile creates an image that has the necessary tools to build and test the controller code.
FROM ubuntu:bionic
RUN apt-get update && apt-get install build-essential python-pip lcov git curl -y
RUN pip install -U pip

# NOTE: pre-commit version is pinned to prevent installing a Python 3-only version.
RUN pip install pre-commit==1.21.0 platformio
RUN platformio update
RUN pip install codecov
RUN pip install cpp-coveralls

WORKDIR /root/Ventilator
COPY . ./
CMD /bin/bash software/gui/gui.sh --install
CMD /bin/bash software/gui/gui.sh --test
CMD /bin/bash software/controller/test.sh
CMD /bin/bash software/controller/controller_coverage.sh
CMD coveralls --build-root software/controller/.pio --gcov-options '\-lp'
CMD /bin/bash bash <(curl -s https://codecov.io/bash) || echo 'Codecov did not collect coverage reports'
